@using KennysCuts.Model
@using KennysCuts.Context
@using System.ComponentModel.DataAnnotations
@inject BookingProvider BookingProvider
@inject NavigationManager NavigationManager

<EditForm Model="@Model" OnValidSubmit="@EditBooking">
    <DataAnnotationsValidator />
    <div class="container py-5">
        <div class="row g-4">
            <div class="row-lg-6 col-12 mt-1">
                <div class="card h-100 shadow-lg rounded-3 border-0">
                    <div class="card-body bg-light d-flex flex-column">
                        <h4 class="card-title text-center text-dark fw-bold mb-4">Booking Details</h4>

                        <!-- Date Field -->
                        <div class="form-group mb-3">
                            <!-- Label for the timeslot input -->
                            <label for="timeslot" class="form-label">Date</label>

                            <!-- Input field for selecting a timeslot, bound to the 'Timeslot' property of the model -->
                            <InputDate id="timeslot" class="form-control" @bind-Value="@Model.Date" placeholder="Enter new date" />

                            <!-- Displays an error message if the 'Timeslot' validation fails -->
                            <div class="small">
                                <ValidationMessage For="@(() => Model.Date)" />
                            </div>
                        </div>

                        <!-- Timeslot Field -->
                        <div class="form-group mb-3">
                            <!-- Label for the timeslot input -->
                            <label for="timeslot" class="form-label">Time</label>

                            <!-- Input field for selecting a timeslot, bound to the 'Timeslot' property of the model -->
                            <InputText id="timeslot" class="form-control" @bind-Value="@Model.Timeslot" placeholder="Enter new time" />

                            <!-- Displays an error message if the 'Timeslot' validation fails -->
                            <div class="small">
                                <ValidationMessage For="@(() => Model.Timeslot)" />
                            </div>
                        </div>

                        <!-- Barber Field -->
                        <div class="form-group mb-3">
                            <!-- Label for the barber input -->
                            <label for="barber" class="form-label">Barber</label>

                            <!-- Input field for entering the barber's name or ID, bound to the 'BarberNameOrId' property of the model -->
                            <InputText id="barber" class="form-control" @bind-Value="@Model.BarberNameOrId" placeholder="Enter barber" />

                            <!-- Validation message displayed for the 'BarberNameOrId' field if validation fails -->
                            <div class="small">
                                <ValidationMessage For="@(() => Model.BarberNameOrId)" />
                            </div>
                        </div>

                        <!-- Service Field -->
                        <div class="form-group mb-3">
                            <!-- Label for the service input -->
                            <label for="services" class="form-label">Service</label>

                            <!-- Input field for entering the service name or ID, bound to the 'ServiceNameOrId' property of the model -->
                            <InputText id="services" class="form-control" @bind-Value="@Model.ServiceNameOrId" placeholder="Enter service" />

                            <!-- Validation message displayed for the 'ServiceNameOrId' field if validation fails -->
                            <div class="small">
                                <ValidationMessage For="@(() => Model.ServiceNameOrId)" />
                            </div>
                        </div>

                        <!-- Email Field -->
                        <div class="form-group mb-3">
                            <!-- Label for the email input -->
                            <label for="email" class="form-label">Email</label>

                            <!-- Input field for entering the user's email, bound to the 'Email' property of the model -->
                            <InputText id="email" class="form-control" @bind-Value="@Model.Email" placeholder="Enter email" />

                            <!-- Validation message displayed for the 'Email' field if validation fails -->
                            <div class="small">
                                <ValidationMessage For="@(() => Model.Email)" />
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <!-- Submit button to either cancel or save changes, based on whether 'Booking' is null -->
                            <button class="btn btn-dark w-48" type="submit">
                                @(Booking == null ? "Cancel Changes" : "Save Changes") <!-- Conditionally renders button text -->
                            </button>
                        </div>

                   </div>
                </div>
            </div>
        </div>
    </div>
</EditForm>

@code {
    [Parameter]
    public Booking? Booking { get; set; }

    private BookingModel Model { get; set; }

    protected override void OnParametersSet()
    {
        if (Booking != null)
        {
            // Populate the model with existing booking details if booking is provided
            Model = new BookingModel(Booking);
        }
        base.OnParametersSet();
    }

    private async Task EditBooking()
    {
        // Use existing booking or create a new one
        var booking = Booking ?? new Booking();

        // Get service by name or ID
        var service = await BookingProvider.GetServiceByNameOrIdAsync(Model.ServiceNameOrId);

        // Get barber by name or ID
        var barber = await BookingProvider.GetBarberByNameOrIdAsync(Model.BarberNameOrId);

        // Assign values to the booking
        booking.Services = service; 
        booking.Barber = barber;
        booking.Date = Model.Date;
        booking.Timeslot = Model.Timeslot;
        booking.Email = Model.Email;

        // Update the booking
        await BookingProvider.UpdateBookingAsync(booking);

        // Redirect to the "my bookings" page
        NavigationManager.NavigateTo("/my-bookings");

    }

    private sealed class BookingModel
    {

        [Required]
        public string ServiceNameOrId { get; set; } = ""; // For binding Service's Name or ID

        [Required]
        public string BarberNameOrId { get; set; } = ""; // For binding Barber's Name or ID

        [Required]
        public DateOnly Date { get; set; }

        [Required]
        public string Timeslot { get; set; } = "";

        [Required]
        public string Email { get; set; } = "";

        public BookingModel()
        {
        }

        public BookingModel(Booking booking)
        {
            // Get the service name from the booking
            ServiceNameOrId = booking.Services.Name;

            // Get the barber's name from the booking
            BarberNameOrId = booking.Barber.Name;

            // Get the booking date
            Date = booking.Date;

            // Get the booking timeslot
            Timeslot = booking.Timeslot;

            // Get the customer's email
            Email = booking.Email;
        }
    }

}

